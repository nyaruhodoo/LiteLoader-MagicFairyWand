"use strict";const ee=require("node:events"),te=require("crypto"),E=require("node:https"),O=require("node:http"),j=require("node:fs"),K=require("node:process"),m=require("node:util"),L=require("node:path"),re=require("node:crypto"),R=require("fs");class ne{ListenerMap;WrapperSession;ListenerManger=new Map;EventTask=new Map;constructor(){}createProxyDispatch(e){const t=this;return new Proxy({},{get(n,s,o){return typeof n[s]>"u"?(...i)=>{t.DispatcherListener.apply(t,[e,s,...i]).then()}:Reflect.get(n,s,o)}})}init({ListenerMap:e,WrapperSession:t}){this.ListenerMap=e,this.WrapperSession=t}CreatEventFunction(e){const t=e.split("/");if(t.length>1){const n="get"+t[0].replace("NodeIKernel",""),s=t[1],o=this.WrapperSession[n]();let i=o[s];return i=i.bind(o),i||void 0}}CreatListenerFunction(e,t=""){const n=this.ListenerMap[e];let s=this.ListenerManger.get(e+t);if(!s&&n){s=new n(this.createProxyDispatch(e));const o=e.match(/^NodeIKernel(.*?)Listener$/)[1],i="NodeIKernel"+o+"Service/addKernel"+o+"Listener";this.CreatEventFunction(i)(s),this.ListenerManger.set(e+t,s)}return s}async DispatcherListener(e,t,...n){this.EventTask.get(e)?.get(t)?.forEach((s,o)=>{if(s.createtime+s.timeout<Date.now()){this.EventTask.get(e)?.get(t)?.delete(o);return}s.checker&&s.checker(...n)&&s.func(...n)})}async CallNoListenerEvent(e="",t=3e3,...n){return new Promise(async(s,o)=>{const i=this.CreatEventFunction(e);let c=!1;setTimeout(()=>{c||o(new Error("NTEvent EventName:"+e+" timeout"))},t);const l=await i(...n);c=!0,s(l)})}async CallNormalEvent(e="",t="",n=1,s=3e3,o,...i){return new Promise(async(c,l)=>{const a=te.randomUUID();let u=0,p,h={};const g=()=>{u==0?l(new Error("NTEvent EventName:"+e+" ListenerName:"+t+" timeout")):c([h,...p])},w=setTimeout(g,s),d=t.split("/"),v=d[0],S=d[1],F={timeout:s,createtime:Date.now(),checker:o,func:(...N)=>{u++,p=N,u>=n&&(clearTimeout(w),g())}};this.EventTask.get(v)||this.EventTask.set(v,new Map),this.EventTask.get(v)?.get(S)||this.EventTask.get(v)?.set(S,new Map),this.EventTask.get(v)?.get(S)?.set(a,F),this.CreatListenerFunction(v),h=await this.CreatEventFunction(e)(...i)})}}class se{core;constructor(e){this.core=e}async copyFile(e,t){await this.core.util.copyFile(e,t)}async getFileSize(e){return await this.core.util.getFileSize(e)}async getVideoUrl(e,t){return(await this.core.session.getRichMediaService().getVideoPlayUrlV2({chatType:e.chatType,peerUid:e.peerUid,guildId:"0"},e.msgId,t.elementId,0,{downSourceType:1,triggerType:1})).urlResult.domainUrl[0].url}}class oe{core;constructor(e){this.core=e}async setCacheSilentScan(e=!0){return""}getCacheSessionPathList(){return""}clearCache(e=["tmp","hotUpdate"]){return this.core.session.getStorageCleanService().clearCacheDataByKeys(e)}addCacheScannedPaths(e={}){return this.core.session.getStorageCleanService().addCacheScanedPaths(e)}scanCache(){return this.core.session.getStorageCleanService().scanCache()}getHotUpdateCachePath(){return""}getDesktopTmpPath(){return""}getChatCacheList(e,t=1e3,n=0){return this.core.session.getStorageCleanService().getChatCacheInfo(e,t,1,n)}getFileCacheInfo(e,t=1e3,n){}async clearChatCache(e=[],t=[]){return this.core.session.getStorageCleanService().clearChatCacheInfo(e,t)}}class ie{core;constructor(e){this.core=e}async isBuddy(e){return this.core.session.getBuddyService().isBuddy(e)}async getFriends(e=!1){let[t,n]=await this.core.event.CallNormalEvent("NodeIKernelBuddyService/getBuddyList","NodeIKernelBuddyListener/onBuddyListChange",1,5e3,()=>!0,e);const s=[];for(const o of n)for(const i of o.buddyList)s.push(i);return s}async handleFriendRequest(e,t){let n=e.split("|");if(n.length<2)return;let s=n[0],o=n[1];this.core.session.getBuddyService()?.approvalFriendRequest({friendUid:s,reqTime:o,accept:t})}}var P=(r=>(r[r.TEXT=1]="TEXT",r[r.PIC=2]="PIC",r[r.FILE=3]="FILE",r[r.PTT=4]="PTT",r[r.VIDEO=5]="VIDEO",r[r.FACE=6]="FACE",r[r.REPLY=7]="REPLY",r[r.ARK=10]="ARK",r[r.MFACE=11]="MFACE",r[r.MARKDOWN=14]="MARKDOWN",r))(P||{}),J=(r=>(r[r.DEFAULTTYPE=0]="DEFAULTTYPE",r[r.TITLETYPE=1]="TITLETYPE",r[r.NEWGROUPTYPE=2]="NEWGROUPTYPE",r))(J||{});class ce{core;constructor(e){this.core=e}async getGroups(e=!1){let[t,n,s]=await this.core.event.CallNormalEvent("NodeIKernelGroupService/getGroupList","NodeIKernelGroupListener/onGroupListUpdate",1,5e3,()=>!0,e);return s}async getGroupRecommendContactArkJson(e){return this.core.session.getGroupService().getGroupRecommendContactArkJson(e)}async CreatGroupFileFolder(e,t){return this.core.session.getRichMediaService().createGroupFolder(e,t)}async DelGroupFile(e,t){return this.core.session.getRichMediaService().deleteGroupFile(e,[102],t)}async DelGroupFileFolder(e,t){return this.core.session.getRichMediaService().deleteGroupFolder(e,t)}async getSingleScreenNotifies(e){let[t,n,s,o]=await this.core.event.CallNormalEvent("NodeIKernelGroupService/getSingleScreenNotifies","NodeIKernelGroupListener/onGroupSingleScreenNotifies",1,5e3,()=>!0,!1,"",e);return o}async getGroupMembers(e,t=3e3){const n=this.core.session.getGroupService(),s=n.createMemberListScene(e,"groupMemberList_MainWindow"),o=await n.getNextMemberList(s,void 0,t);if(o.errCode!==0)throw"获取群成员列表出错,"+o.errMsg;return o.result.infos}async getGroupNotifies(){}async GetGroupFileCount(e){return this.core.session.getRichMediaService().batchGetGroupFileCount(e)}async getGroupIgnoreNotifies(){}async getArkJsonGroupShare(e){return(await this.core.event.CallNoListenerEvent("NodeIKernelGroupService/getGroupRecommendContactArkJson",5e3,e)).arkJson}async handleGroupRequest(e,t,n){return this.core.session.getGroupService().operateSysNotify(!1,{operateType:t,targetMsg:{seq:e.seq,type:e.type,groupCode:e.group.groupCode,postscript:n||""}})}async quitGroup(e){return this.core.session.getGroupService().quitGroup(e)}async kickMember(e,t,n=!1,s=""){return this.core.session.getGroupService().kickMember(e,t,n,s)}async banMember(e,t){return this.core.session.getGroupService().setMemberShutUp(e,t)}async banGroup(e,t){return this.core.session.getGroupService().setGroupShutUp(e,t)}async setMemberCard(e,t,n){return this.core.session.getGroupService().modifyMemberCardName(e,t,n)}async setMemberRole(e,t,n){return this.core.session.getGroupService().modifyMemberRole(e,t,n)}async setGroupName(e,t){return this.core.session.getGroupService().modifyGroupName(e,t,!1)}async setGroupTitle(e,t,n){}async getGroupRemainAtTimes(e){this.core.session.getGroupService().getGroupRemainAtTimes(e)}async getMemberExtInfo(e,t){return this.core.session.getGroupService().getMemberExtInfo({groupCode:e,sourceType:J.TITLETYPE,beginUin:"0",dataTime:"0",uinList:[t],uinNum:"",seq:"",groupType:"",richCardNameVer:"",memberExtFilter:{memberLevelInfoUin:1,memberLevelInfoPoint:1,memberLevelInfoActiveDay:1,memberLevelInfoLevel:1,memberLevelInfoName:1,levelName:1,dataTime:1,userShowFlag:1,sysShowFlag:1,timeToUpdate:1,nickName:1,specialTitle:1,levelNameNew:1,userShowFlagNew:1,msgNeedField:1,cmdUinFlagExt3Grocery:1,memberIcon:1,memberInfoSeq:1}})}}class ae{core;constructor(e){this.core=e}async setEmojiLike(e,t,n,s=!0){return n=n.toString(),this.core.session.getMsgService().setMsgEmojiLikes(e,t,n,n.length>3?"2":"1",s)}async getMultiMsg(e,t,n){return this.core.session.getMsgService().getMultiMsg(e,t,n)}async getMsgsByMsgId(e,t){return await this.core.session.getMsgService().getMsgsByMsgId(e,t)}async getMsgsBySeqAndCount(e,t,n,s,o){return await this.core.session.getMsgService().getMsgsBySeqAndCount(e,t,n,s,o)}async activateChat(e){}async activateChatAndGetHistory(e){}async sendMsgExtend(e,t){let n=this.core.session.getMsgService().getMsgUniqueId(Date.now().toString());return this.core.session.getMsgService().sendMsg(n,e,t,new Map)}async setMsgRead(e){return this.core.session.getMsgService().setMsgRead(e)}async getMsgHistory(e,t,n){return this.core.session.getMsgService().getMsgsIncludeSelf(e,t,n,!0)}async fetchRecentContact(){}async recallMsg(e,t){await this.core.session.getMsgService().recallMsg({chatType:e.chatType,peerUid:e.peerUid},t)}async forwardMsg(e,t,n){return this.core.session.getMsgService().forwardMsg(n,e,[t],new Map)}}class y{static async HttpsGetCookies(e){const t=e.startsWith("https")?E:O;return new Promise((n,s)=>{t.get(e,i=>{let c={};const l=a=>{if(a.statusCode===301||a.statusCode===302)if(a.headers.location){const u=new URL(a.headers.location,e);y.HttpsGetCookies(u.href).then(p=>{c={...c,...p},n(c)}).catch(p=>{s(p)})}else n(c);else n(c)};i.on("data",()=>{}),i.on("end",()=>{l(i)}),i.headers["set-cookie"]&&i.headers["set-cookie"].forEach(a=>{const u=a.split(";")[0].split("="),p=u[0],h=u[1];p&&h&&p.length>0&&h.length>0&&(c[p]=h)})}).on("error",i=>{s(i)})})}static async HttpGetJson(e,t="GET",n,s={},o=!0,i=!0){const c=new URL(e),l=e.startsWith("https://")?E:O,a={hostname:c.hostname,port:c.port,path:c.href,method:t,headers:s};return new Promise((u,p)=>{const h=l.request(a,g=>{let w="";g.on("data",d=>{w+=d.toString()}),g.on("end",()=>{try{if(g.statusCode&&g.statusCode>=200&&g.statusCode<300)if(o){const d=JSON.parse(w);u(d)}else u(w);else p(new Error(`Unexpected status code: ${g.statusCode}`))}catch(d){p(d)}})});h.on("error",g=>{p(g)}),(t==="POST"||t==="PUT"||t==="PATCH")&&(i?h.write(JSON.stringify(n)):h.write(n)),h.end()})}static async HttpGetText(e,t="GET",n,s={}){return this.HttpGetJson(e,t,n,s,!1,!1)}static async createFormData(e,t){let n="image/png";t.endsWith(".jpg")&&(n="image/jpeg");const s=[`------${e}\r
`,`Content-Disposition: form-data; name="share_image"; filename="${t}"\r
`,"Content-Type: "+n+`\r
\r
`],o=j.readFileSync(t),i=`\r
------${e}--`;return Buffer.concat([Buffer.from(s.join(""),"utf8"),o,Buffer.from(i,"utf8")])}}class le{core;constructor(e){this.core=e}async setLongNick(e){return this.core.session.getProfileService().setLongNick(e)}async setSelfOnlineStatus(e,t,n){return this.core.session.getMsgService().setStatus({status:e,extStatus:t,batteryStatus:n})}async getBuddyRecommendContactArkJson(e,t=""){return this.core.session.getBuddyService().getBuddyRecommendContactArkJson(e,t)}async like(e,t=1){return this.core.session.getProfileLikeService().setBuddyProfileLike({friendUid:e,sourceId:71,doLikeCount:t,doLikeTollCount:0})}async setQQAvatar(e){const t=await this.core.session.getProfileService().setHeader(e);return{result:t?.result,errMsg:t?.errMsg}}async getSelfInfo(){}async getUserInfo(e){}async modifySelfProfile(e){return this.core.session.getProfileService().modifyDesktopMiniProfile(e)}async getPSkey(e){return await this.core.session.getTipOffService().getPskey(e,!0)}async getQzoneCookies(e,t){const n="https://ssl.ptlogin2.qq.com/jump?ptlang=1033&clientuin="+e+"&clientkey="+t+"&u1=https%3A%2F%2Fuser.qzone.qq.com%2F"+e+"%2Finfocenter&keyindex=19%27";return await y.HttpsGetCookies(n)}async getSkey(e,t){const n="https://ssl.ptlogin2.qq.com/jump?ptlang=1033&clientuin="+e+"&clientkey="+t+"&u1=https%3A%2F%2Fh5.qzone.qq.com%2Fqqnt%2Fqzoneinpcqq%2Ffriend%3Frefresh%3D0%26clientuin%3D0%26darkMode%3D0&keyindex=19%27",o=(await y.HttpsGetCookies(n)).skey;if(!o)throw new Error("getSkey Skey is Empty");return o}async getRobotUinRange(){return(await this.core.session.getRobotService().getRobotUinRange({justFetchMsgConfig:"1",type:1,version:0,aioKeywordVersion:0}))?.response?.robotUinRanges}async getUidByUin(e){return(await this.core.event.CallNoListenerEvent("NodeIKernelUixConvertService/getUid",5e3,[e])).uidInfo.get(e)}async getUinByUid(e){return e?(await this.core.event.CallNoListenerEvent("NodeIKernelUixConvertService/getUin",5e3,[e])).uinInfo.get(e):""}async getUserDetailInfo(e){let[t,n]=await this.core.event.CallNormalEvent("NodeIKernelProfileService/getUserDetailInfo","NodeIKernelProfileListener/onProfileDetailInfoChanged",2,5e3,s=>s.uid===e,e);return n}static async getCookies(e,t,n){const s="https://ssl.ptlogin2.qq.com/jump?ptlang=1033&clientuin="+e+"&clientkey="+t+"&u1=https%3A%2F%2F"+n+"%2F"+e+"%2Finfocenter&keyindex=19%27";return await y.HttpsGetCookies(s)}async getUserDetailInfoByUin(e){return this.core.event.CallNoListenerEvent("NodeIKernelProfileService/getUserDetailInfoByUin",5e3,e)}async forceFetchClientKey(){return await this.core.session.getTicketService().forceFetchClientKey("")}}class ue{async getGroupEssenceMsg(e,t,n,s){const o="https://qun.qq.com/cgi-bin/group_digest/digest_list?bkn="+s+"&group_code="+e+"&page_start="+t+"&page_limit=20";let i;try{i=await y.HttpGetJson(o,"GET","",{Cookie:n})}catch{return}if(i.retcode===0)return i}async getGroupMembers(e,t,n){let s=new Array;try{const o=[],i=await y.HttpGetJson("https://qun.qq.com/cgi-bin/qun_mgr/search_group_members?st=0&end=40&sort=1&gc="+e+"&bkn="+n,"POST","",{Cookie:t});if(!i?.count||i?.errcode!==0||!i?.mems)return[];for(const l in i.mems)s.push(i.mems[l]);const c=Math.ceil(i.count/40);for(let l=2;l<=c;l++){const a=y.HttpGetJson("https://qun.qq.com/cgi-bin/qun_mgr/search_group_members?st="+(l-1)*40+"&end="+l*40+"&sort=1&gc="+e+"&bkn="+n,"POST","",{Cookie:t});o.push(a)}for(let l=1;l<=c;l++){const a=await o[l];if(!(!a?.count||a?.errcode!==0||!a?.mems))for(const u in a.mems)s.push(a.mems[u])}}catch{return s}return s}async setGroupNotice(e,t="",n,s){let o;const i="https://web.qun.qq.com/cgi-bin/announce/add_qun_notice?bkn="+s;try{return o=await y.HttpGetJson(i,"GET","",{Cookie:n}),o}catch{return}}async getGrouptNotice(e,t,n){let s;const o="https://web.qun.qq.com/cgi-bin/announce/get_t_list?bkn="+n+"&qid="+e+"&ft=23&ni=1&n=1&i=1&log_read=1&platform=1&s=-1&n=20";try{return s=await y.HttpGetJson(o,"GET","",{Cookie:t}),s?.ec!==0?void 0:s}catch{return}}genBkn(e){e=e||"";let t=5381;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=t+(t<<5)+s}return(t&2147483647).toString()}async getGroupHonorInfo(e,t,n){async function s(i,c){let l="https://qun.qq.com/interactive/honorlist?gc="+i+"&type="+c.toString(),a="",u;try{a=await y.HttpGetText(l,"GET","",{Cookie:n});const p=a.match(/window\.__INITIAL_STATE__=(.*?);/);return p&&(u=JSON.parse(p[1].trim())),c===1?u?.talkativeList:u?.actorList}catch{}}let o={group_id:e};if(t==="talkative"||t==="all")try{let i=await s(e,1);if(!i)throw new Error("获取龙王信息失败");o.current_talkative={user_id:i[0]?.uin,avatar:i[0]?.avatar,nickname:i[0]?.name,day_count:0,description:i[0]?.desc},o.talkative_list=[];for(const c of i)o.talkative_list.push({user_id:c?.uin,avatar:c?.avatar,description:c?.desc,day_count:0,nickname:c?.name})}catch{}if(t==="performer"||t==="all")try{let i=await s(e,2);if(!i)throw new Error("获取群聊之火失败");o.performer_list=[];for(const c of i)o.performer_list.push({user_id:c?.uin,nickname:c?.name,avatar:c?.avatar,description:c?.desc})}catch{}if(t==="performer"||t==="all")try{let i=await s(e,3);if(!i)throw new Error("获取群聊炽焰失败");o.legend_list=[];for(const c of i)o.legend_list.push({user_id:c?.uin,nickname:c?.name,avatar:c?.avatar,desc:c?.description})}catch{}if(t==="emotion"||t==="all")try{let i=await s(e,6);if(!i)throw new Error("获取快乐源泉失败");o.emotion_list=[];for(const c of i)o.emotion_list.push({user_id:c?.uin,nickname:c?.name,avatar:c?.avatar,desc:c?.description})}catch{}return(t==="emotion"||t==="all")&&(o.strong_newbie_list=[]),o}}class pe{core;constructor(e){this.core=e}async hasOtherRunningQQProcess(){return this.core.util.hasOtherRunningQQProcess()}async ORCImage(e){return this.core.session.getNodeMiscService().wantWinScreenOCR(e)}async translateEnWordToZn(e){return this.core.session.getRichMediaService().translateEnWordToZn(e)}async getOnlineDev(){return this.core.session.getMsgService().getOnLineDev()}async getArkJsonCollection(e){return await this.core.event.CallNoListenerEvent("NodeIKernelCollectionService/collectionArkShare",5e3,"1717662698058")}async BootMiniApp(e,t){await this.core.session.getNodeMiscService().setMiniAppVersion("2.16.4");let n=await this.core.session.getNodeMiscService().getMiniAppPath();return console.log(n),this.core.session.getNodeMiscService().startNewMiniApp(e,t)}}class ge{core;constructor(e){this.core=e}async createCollection(e,t,n,s,o){let i={commInfo:{bid:1,category:2,author:{type:1,numId:e,strId:n,groupId:"0",groupName:"",uid:t},customGroupId:"0",createTime:Date.now().toString(),sequence:Date.now().toString()},richMediaSummary:{originalUri:"",publisher:"",richMediaVersion:0,subTitle:"",title:"",brief:s,picList:[],contentType:1},richMediaContent:{rawData:o,bizDataList:[],picList:[],fileList:[]},need_share_url:!1};return this.core.session.getCollectionService().createNewCollectionItem(i)}async getAllCollection(e=0,t=50){let n={category:e,groupId:-1,forceSync:!0,forceFromDb:!1,timeStamp:"0",count:t,searchDown:!0};return this.core.session.getCollectionService().getCollectionItemList(n)}}class de{session;util;event;ApiCollection;ApiFile;ApiFileCache;ApiFriend;ApiGroup;ApiMsg;ApiSystem;ApiUser;ApiWeb;constructor(e,t){this.session=t,this.util=new e.NodeQQNTWrapperUtil,this.event=new ne,this.event.init({ListenerMap:e,WrapperSession:this.session}),this.ApiCollection=new ge(this),this.ApiFile=new se(this),this.ApiFileCache=new oe(this),this.ApiFriend=new ie(this),this.ApiGroup=new ce(this),this.ApiMsg=new ae(this),this.ApiSystem=new pe(this),this.ApiUser=new le(this),this.ApiWeb=new ue}getWrapperSession(){return this.session}getWrapperUtil(){return this.util}getApiCollection(){return this.ApiCollection}getApiFile(){return this.ApiFile}getApiFileCache(){return this.ApiFileCache}getApiFriend(){return this.ApiFriend}getApiGroup(){return this.ApiGroup}getApiMsg(){return this.ApiMsg}getApiSystem(){return this.ApiSystem}getApiUser(){return this.ApiUser}getApiWeb(){return this.ApiWeb}}var f=(r=>(r.sendLog="NodeIQQNTWrapperSession/create/getNodeMiscService/sendLog",r.onQRCodeLoginSucceed="NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed",r.onRecvMsg="NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",r.sendMsg="NodeIQQNTWrapperSession/create/getMsgService/sendMsg",r.requestTianshuAdv="NodeIQQNTWrapperSession/create/getMsgService/requestTianshuAdv",r.onProfileSimpleChanged="NodeIQQNTWrapperSession/create/getProfileService/addKernelProfileListener/onProfileSimpleChanged",r.fetchUserDetailInfo="NodeIQQNTWrapperSession/create/getProfileService/fetchUserDetailInfo",r.onUserDetailInfoChanged="NodeIQQNTWrapperSession/create/getProfileService/addKernelProfileListener/onUserDetailInfoChanged",r.getVasInfo="NodeIQQNTWrapperSession/create/getProfileService/getVasInfo",r.setThemeInfo="NodeIQQNTWrapperSession/create/getSkinService/setThemeInfo",r.onThemeInfoChange="NodeIQQNTWrapperSession/create/getSkinService/addKernelSkinListener/onThemeInfoChange",r.previewTheme="NodeIQQNTWrapperSession/create/getSkinService/previewTheme",r.getSystemThemePackageList="NodeIQQNTWrapperSession/create/getSkinService/getSystemThemePackageList",r.getTemplateThemeList="NodeIQQNTWrapperSession/create/getSkinService/getTemplateThemeList",r.onRecvActiveMsg="nodeIKernelMsgListener/onRecvActiveMsg",r))(f||{});let x,B,$;const I=new ee.EventEmitter,z=new Map,H=new Map;let C;const q=({argArray:r,ret:e,key:t})=>{if(t.endsWith("Service")&&H.has(t)||!C?.log)return;t.endsWith("Service")&&H.set(t,!0);const n=null;if(console.log("-----------------------------------------------"),console.log(`${t} 被调用`),r.length&&console.log("参数: ",m.inspect(r,{depth:n,colors:!0})),e instanceof Promise)console.log("返回值为 Promise，请观察后续打印内容"),e.then(s=>{console.log(`${t} 返回值: `),console.log(m.inspect(s,{depth:n,colors:!0}))},s=>{console.log(`${t} 返回值: `),console.log(m.inspect(s,{depth:n,colors:!0}))});else if(console.log("返回值: ",m.inspect(e,{depth:n,colors:!0})),typeof e=="object"&&e){const s=Object.getOwnPropertyNames(e);s.length&&console.log("返回值 keys: ",m.inspect(s,{depth:n,colors:!0})),console.log("原型 keys: ",m.inspect(Object.getOwnPropertyNames(Object.getPrototypeOf(e)),{depth:n,colors:!0}))}},b=({instance:r,rootKey:e})=>new Proxy(r,{get(t,n,s){const o=Reflect.get(r,n,s);if(typeof o!="function")return o;const i=`${e}/${n}`;return(...c)=>{if(C?.eventBlacklist?.some(u=>typeof u=="string"?i===u:u.test(i)))return;i.endsWith("Listener")&&(c[0]=b({instance:c[0],rootKey:i}),z.set(i,c[0])),c=C?.eventInterceptors?.[i]?.(c)??c;let a=r[n](...c);return a=C?.eventInterceptors?.[`${i}:response`]?.(a)??a,i.endsWith("Service")&&(a=b({instance:a,rootKey:i})),I.emit(i,{applyRet:a,args:c}),q({argArray:c,ret:a,key:i}),a}}}),he=r=>{C=r;const{promise:e,resolve:t}=Promise.withResolvers();return K.dlopen=new Proxy(K.dlopen,{apply(n,s,o){const[,i]=o,c=Reflect.apply(n,s,o);if(i.includes("wrapper.node")){const l=o[0].exports,a=new Proxy(l,{get(u,p,h){const g=Reflect.get(l,p,h);return typeof g!="function"?g:new Proxy(function(){},{get(w,d,v){const S=Reflect.get(g,d,v);return typeof S!="function"?S:new Proxy(S,{apply(F,U,N){const M=Reflect.apply(F,U,N),A=`${p}/${d}`;if(q({argArray:N,ret:M,key:A}),typeof M!="object")return M;const W=b({instance:M,rootKey:A});return A==="NodeIQQNTWrapperSession/create"&&(x=W),W}})},construct(w,d,v){const S=Reflect.construct(g,d,v);return q({key:p,ret:S,argArray:d}),b({instance:S,rootKey:p})}})}});B=o[0].exports=a}return c}}),I.once(f.onQRCodeLoginSucceed,()=>{t($=new de(B,x))}),e},T=r=>(r.vipStartFlag=0,r.vipDataFlag=0,r.vipFlag=!0,r.svipFlag=!0,r.yearVipFlag=!0,r.vipLevel=10,r.nameplateVipType=258,r.superVipTemplateId=20471,r.pendantId=104493,r.vipDataFlag=107,r.vipNameColorId="6",r.privilegeIcon.openIconList=[],r.privilegeIcon.closeIconList=[],r),k=()=>globalThis?.authData?.uid??"",fe={async[f.fetchUserDetailInfo+":response"](r){const e=k(),t=await r,n=t.detail.get(e);if(n)return n.simpleInfo.vasInfo=T(n.simpleInfo.vasInfo),t},[f.onUserDetailInfoChanged]([r]){const e=k();r.uid===e&&(r.simpleInfo.vasInfo=T(r.simpleInfo.vasInfo))},[f.onProfileSimpleChanged]([r]){const e=k(),t=r.get(e);!t||!t.vasInfo||(t.vasInfo=T(t.vasInfo))},[f.getVasInfo+":response"](r){const e=k(),t=r.get(e);t&&T(t)}},V={theme:null},me=4,ye="extension",ve="星之杖",Y="liteloader-star-wand",Se="你相信魔法吗",we="0.0.1",Ce=[{name:"Nyaruhodo",link:"https://github.com/nyaruhodoo"}],Ie={repo:"nyaruhodoo/LiteLoader-StarWand",branch:"master"},Ne=[],Me=["win32","linux","darwin"],Te={renderer:"./out/renderer/index.js",main:"./out/main/index.js",preload:"./out/preload/index.js"},ke="./icon.gif",Le="./thumb.svg",G={manifest_version:me,type:ye,name:ve,slug:Y,description:Se,version:we,authors:Ce,repository:Ie,dependencies:Ne,platform:Me,injects:Te,icon:ke,thumb:Le};class Q{static async getConfig(){const e=await LiteLoader.api.config.get(G.slug,V);return this.mergeConfig(e,V)}static async updateConfig(e){await LiteLoader.api.config.set(G.slug,e),this.log("Config已更新",JSON.stringify(e))}static mergeConfig(e,t){const n=structuredClone(t);for(const[s,o]of Object.entries(e))if(Object.hasOwn(n,s)&&Object.prototype.toString.call(o)===Object.prototype.toString.call(n[s])){if(Array.isArray(o)){n[s]=[...new Set([...o,...n[s]])];continue}if(typeof o=="object"&&o){n[s]=this.mergeConfig(o,n[s]);continue}n[s]=o}return n}static log(...e){console.log(`${G.slug}:`,...e)}static randomInteger(e,t){const n=e+Math.random()*(t+1-e);return Math.floor(n)}static wait(e){if(!(e<=0))return new Promise(t=>setTimeout(t,e))}static createDeepProxy(e,t){for(const n in e)typeof e[n]=="object"&&e[n]&&(e[n]=Q.createDeepProxy(e[n],t));return new Proxy(e,t)}static getProperty(e,t){let n=e;const s=t.split(".");for(;s.length;){const o=s.shift();if(!o)return;n=n[o]}return n}static setProperty(e,t,n){let s=e;const o=t.split("."),i=o.pop();if(i){for(;o.length;){const c=o.shift();if(!c)return;s=s[c]}return s[i]=n}}}let _,D;const X=r=>{if(r instanceof Map){const e={};for(const[t,n]of r)e[t]=n;return e}else if(typeof r=="object"&&r!==null){const e=new Map;for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e.set(t,r[t]);return e}else throw new Error("输入必须是 Map 或 Object")},be=(r,e)=>{for(const t of e){const n=t.themeList.find(s=>s.themeId===r);if(n)return n}},Pe=async r=>{const e=z.get("NodeIQQNTWrapperSession/create/getSkinService/addKernelSkinListener");if(!e||!D)return;const t=r[0];let n=be(r[0],D);n||(n={themeId:t,themeName:r[2].themeName,themeDesc:"",requirement:0,themeMediaPreview:"",themeVideo:"",themePalette:"",themePreviewLight:"",themePreviewDark:"",light:{primaryColor:r[2].primaryColor,aioInfo:r[2].aioInfo,bubbleInfo:r[2].bubbleInfo},dark:{primaryColor:r[2].primaryColor,aioInfo:r[2].aioInfo,bubbleInfo:r[2].bubbleInfo}});const s=[t,n,null,null,_];await Q.updateConfig({theme:[t,n,null,null,X(_)]}),e.onThemeInfoChange(...s)},Fe={async[`${f.getSystemThemePackageList}:response`](r){return D=(await r).systemThemePackageList,r},async[`${f.previewTheme}:response`](r){return _=(await r).tokenMap,r},[f.setThemeInfo](r){Pe(r)},async[`${f.setThemeInfo}:response`](){return{result:0,errMsg:""}},[f.onThemeInfoChange](r){const e=JSON.parse(j.readFileSync(`${LiteLoader.plugins[Y].path.data}/config.json`,"utf8"));if(!e.theme)return;const t=e.theme[0];return r[0]!==t?(e.theme[4]=X(e.theme[4]),e.theme):r}};I.addListener("NodeIQQNTWrapperSession/create/getMsgService/downloadRichMedia",r=>{console.log("downloadRichMedia"),console.log(m.inspect(r,{depth:null,colors:!0}))});I.addListener("NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRichMediaDownloadComplete",r=>{console.log("onRichMediaDownloadComplete"),console.log(m.inspect(r,{depth:null,colors:!0}))});I.addListener("NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",r=>{console.log("onRecvMsg"),console.log(m.inspect(r,{depth:null,colors:!0}))});const Z=r=>{const e=re.createHash("md5"),t=R.readFileSync(r);return e.update(t),e.digest("hex")},Ae=(r,e)=>{const t=L.dirname(e);if(!R.existsSync(t))throw new Error("路径不存在");return R.copyFileSync(r,e),e},Ge=(r,e)=>{const t=$?.session.getMsgService().getRichMediaFilePathForGuild({md5HexStr:Z(r),fileName:e,elementType:P.VIDEO,elementSubType:0,thumbSize:0,needCreate:!0,downloadType:1,file_uuid:""});if(!t)throw new Error("路径生成失败，请检查参数是否有误");return t},Re=r=>L.join(L.dirname(r.replace("Ori","Thumb"))),qe=r=>{const e=[".mp4",".avi",".mkv",".mov",".wmv",".flv",".webm",".m4v",".mpeg",".mpg",".3gp"],t=L.extname(r).toLowerCase();return e.includes(t)},_e=r=>{console.log("原视频数据"),console.log(m.inspect(r,{depth:null,colors:!0}));const{fileName:e,filePath:t,picHeight:n,picWidth:s,picThumbPath:o,fileSize:i}=r[2][0].fileElement,c=Ge(t,e);if(Ae(t,c),!o?.get(750))throw new Error("原视频封面丢失");Re(c);const a=new Map;a.set(0,"C:\\Users\\Administrator\\Documents\\Tencent Files\\3751329135\\nt_qq\\nt_data\\Video\\2024-09\\Thumb\\b99f4ee4550670d05e3492002a7c0428_0.png");const u={elementType:P.VIDEO,elementId:"",videoElement:{filePath:c,fileName:e,videoMd5:Z(c),thumbMd5:"f3ec62461020f1001d969ae60c63d6c8",fileTime:10,thumbSize:7492,fileSize:i,thumbWidth:s,thumbHeight:n,thumbPath:a}};return r[2][0]=u,console.log("魔改的的视频数据"),console.log(m.inspect(r,{depth:null,colors:!0})),r},De={[f.sendMsg](r){if(r[2][0].elementType!==P.FILE)return r;const{filePath:e}=r[2][0].fileElement;return qe(e)?_e(r):r}};(async()=>await he({log:!1,eventBlacklist:[f.sendLog,/tianshu/i],eventInterceptors:{...fe,...Fe,...De}}))();
